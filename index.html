<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Video Reference Archive</title>
  <style>
function baseCardHTML(item, thumbUrl) {
  const url = item[KEY.url] || "#";

  const date = (item[KEY.date] || "").toString().trim();        // ë°œí–‰ì¼
  const channel = (item[KEY.channel] || "").toString().trim();  // ì±„ë„ëª…
  const media = (item[KEY.media] || "").toString().trim();      // ë§¤ì²´
  const genre = (item[KEY.genre] || "").toString().trim();      // ì¥ë¥´
  const format = (item[KEY.format] || "").toString().trim();    // í¬ë§·
  const tags = splitTags(item[KEY.tag]);                        // TAG
  const tagLine = tags.join(", ");

  return `
    <div class="card">
      <a class="cleanLink" href="${url}" target="_blank" rel="noopener noreferrer">
        <div class="thumbWrap">
          <img class="thumb" src="${thumbUrl}" alt="thumbnail" loading="lazy"/>
        </div>

        <div class="metaBox">
          <div class="metaDate">${escapeHTML(date || "ë‚ ì§œ")}</div>

          <div class="metaGrid">
            <div class="metaLeft">
              <div class="channel">${escapeHTML(channel || "ì±„ë„ëª…")}</div>
              <div>${escapeHTML(media || "ë§¤ì²´")}</div>
            </div>

            <div class="metaRight">
              <div>${escapeHTML(genre || "ì¥ë¥´")}</div>
              <div>${escapeHTML(format || "í¬ë§·")}</div>
            </div>
          </div>

          <div class="metaTagLine">${escapeHTML(tagLine || "íƒœê·¸")}</div>
        </div>
      </a>
    </div>
  `;
}
  </style>
</head>
<body>

  <h1>ğŸ¬ Video Reference Archive</h1>
  <div class="sub">
    Google Sheet â†’ JSON(OpenSheet) ìë™ ì—°ë™<br/>
    í•„í„° ì¹©: <b>ì¥ë¥´/ë§¤ì²´/í¬ë§·/TAG</b> + ê²€ìƒ‰<br/>
    ì •ë ¬: <b>ë°œí–‰ì¼ ìµœì‹ ìˆœ</b> (ì‹œíŠ¸ ì»¬ëŸ¼ëª…: <code>ë°œí–‰ì¼</code>, ì¶”ì²œ í˜•ì‹: <code>YYYY-MM-DD</code>)<br/>
    ì¸ë„¤ì¼: <b>YouTube ìë™</b> + TikTok/Instagram <b>ê°€ëŠ¥í•˜ë©´ ìë™(oEmbed ì‹œë„)</b> / ì‹¤íŒ¨ ì‹œ <b>thumb ì»¬ëŸ¼</b> ì¶”ì²œ
  </div>

  <div class="controls">
    <input id="search" type="text" placeholder="ì œëª© ê²€ìƒ‰..." />
  </div>

  <div class="toolbar">
    <button class="btn" id="resetBtn">í•„í„° ì´ˆê¸°í™”</button>
    <div class="stats" id="stats"></div>
  </div>

  <div class="divider"></div>

  <div class="sectionTitle">ì¥ë¥´</div>
  <div class="chips" id="genreChips"></div>

  <div class="sectionTitle">ë§¤ì²´</div>
  <div class="chips" id="mediaChips"></div>

  <div class="sectionTitle">í¬ë§·</div>
  <div class="chips" id="formatChips"></div>

  <div class="sectionTitle">TAG</div>
  <div class="chips" id="tagChips"></div>

  <div class="divider"></div>

  <div class="grid" id="grid"></div>

  <div class="footer">
    âœ… TikTok/Instagram ì¸ë„¤ì¼ì´ ì•ˆ ëœ¨ë©´ ì‹œíŠ¸ì— <b>thumb</b>(ë˜ëŠ” THUMB/ì¸ë„¤ì¼) ì»¬ëŸ¼ì„ ì¶”ê°€í•´ ì¸ë„¤ì¼ URLì„ ë„£ì–´ì£¼ì„¸ìš” (ê°€ì¥ ì•ˆì •).<br/>
    âœ… TAGëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„: ì˜ˆ) <code>ì‹¤ì‚¬ì´¬ì˜,ê°œë°œì,Gameplay</code>
  </div>

<script>
/** âœ… ë„¤ OpenSheet URL (ì‚¬ìš©ì ì œê³µ) */
const SHEET_URL = "https://opensheet.elk.sh/1GgTfXN-iChTCdW3vHYFwQu2WSlwmgOm2-pHs2WIBBAY/ARCHIVE";

/** âœ… ì‹œíŠ¸ ì»¬ëŸ¼ëª…(í‚¤) â€” ì‹œíŠ¸ í—¤ë”ì™€ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•¨ */
const KEY = {
  genre: "ì¥ë¥´",
  channel: "ì±„ë„ëª…",
  title: "TITLE",
  media: "ë§¤ì²´",
  url: "URL",
  format: "í¬ë§·",
  tag: "TAG",
  date: "ë°œí–‰ì¼",     // âœ… ì¶”ê°€ë¨
  note: "ë©”ëª¨",
  thumbCandidates: ["thumb", "THUMB", "ì¸ë„¤ì¼"]
};

let allData = [];

// ë‹¨ì¼ ì„ íƒ í•„í„°(ì¹©)
let activeGenre = null;
let activeMedia = null;
let activeFormat = null;
let activeTag = null;

const gridEl = document.getElementById("grid");
const statsEl = document.getElementById("stats");
const searchEl = document.getElementById("search");

const genreChipsEl = document.getElementById("genreChips");
const mediaChipsEl = document.getElementById("mediaChips");
const formatChipsEl = document.getElementById("formatChips");
const tagChipsEl = document.getElementById("tagChips");

const resetBtn = document.getElementById("resetBtn");

const THUMB_PLACEHOLDER = "https://via.placeholder.com/800x450?text=No+Thumbnail";
const thumbCache = new Map();

function escapeHTML(str) {
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function normalizeTagString(s) {
  return (s || "")
    .replaceAll("ï¼Œ", ",")
    .replaceAll(" / ", ",")
    .replaceAll("/", ",")
    .trim();
}

function splitTags(s) {
  return normalizeTagString(s)
    .split(",")
    .map(t => t.trim())
    .filter(Boolean);
}

/** ë°œí–‰ì¼ íŒŒì‹± (YYYY-MM-DD / YYYY.MM.DD / YYYY/MM/DD ì–´ëŠ ì •ë„ ëŒ€ì‘) */
function parseDateLoose(v) {
  const s = (v || "").toString().trim();
  if (!s) return null;

  // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš°(ì˜ˆ: 20250315)ë„ ì–´ëŠ ì •ë„ ë³´ì • ê°€ëŠ¥
  if (/^\d{8}$/.test(s)) {
    const y = s.slice(0,4), m = s.slice(4,6), d = s.slice(6,8);
    return new Date(`${y}-${m}-${d}T00:00:00`);
  }

  // êµ¬ë¶„ì í†µì¼
  const norm = s.replaceAll(".", "-").replaceAll("/", "-");
  const dt = new Date(norm);
  if (!isNaN(dt.getTime())) return dt;

  return null;
}

function sortByDateDesc(data) {
  return [...data].sort((a, b) => {
    const da = parseDateLoose(a[KEY.date]);
    const db = parseDateLoose(b[KEY.date]);
    const ta = da ? da.getTime() : 0;
    const tb = db ? db.getTime() : 0;
    return tb - ta;
  });
}

function getYoutubeID(url) {
  try {
    const u = new URL(url);
    if (u.hostname.includes("youtu.be")) return u.pathname.replace("/", "").slice(0, 11);
    if (u.searchParams.get("v")) return u.searchParams.get("v").slice(0, 11);
    const parts = u.pathname.split("/").filter(Boolean);
    const idxShorts = parts.indexOf("shorts");
    if (idxShorts >= 0 && parts[idxShorts + 1]) return parts[idxShorts + 1].slice(0, 11);
    return null;
  } catch { return null; }
}

function getSheetThumb(item) {
  for (const k of KEY.thumbCandidates) {
    if (item[k] && String(item[k]).trim()) return String(item[k]).trim();
  }
  return "";
}

function classifyPlatform(url) {
  const u = (url || "").toLowerCase();
  if (u.includes("youtube.com") || u.includes("youtu.be")) return "youtube";
  if (u.includes("tiktok.com")) return "tiktok";
  if (u.includes("instagram.com")) return "instagram";
  if (u.includes("vimeo.com")) return "vimeo";
  return "other";
}

/** oEmbedë¡œ ì¸ë„¤ì¼ ì‹œë„ (ì„±ê³µí•˜ë©´ URL ë°˜í™˜, ì‹¤íŒ¨í•˜ë©´ ë¹ˆ ë¬¸ìì—´) */
async function tryOEmbedThumb(platform, url) {
  try {
    let endpoint = "";
    if (platform === "instagram") {
      endpoint = "https://api.instagram.com/oembed/?url=" + encodeURIComponent(url);
    } else if (platform === "tiktok") {
      endpoint = "https://www.tiktok.com/oembed?url=" + encodeURIComponent(url);
    } else {
      return "";
    }
    const res = await fetch(endpoint, { mode: "cors" });
    if (!res.ok) return "";
    const json = await res.json();
    return (json.thumbnail_url || json.thumbnail_url_with_play_button || "") || "";
  } catch {
    return "";
  }
}

async function resolveThumbnail(item) {
  const url = item[KEY.url] || "";
  if (!url) return THUMB_PLACEHOLDER;

  // 1) ì‹œíŠ¸ thumb ì»¬ëŸ¼ì´ ìˆìœ¼ë©´ ìµœìš°ì„ 
  const sheetThumb = getSheetThumb(item);
  if (sheetThumb) return sheetThumb;

  // 2) ìºì‹œ
  if (thumbCache.has(url)) return thumbCache.get(url);

  // 3) í”Œë«í¼ë³„
  const platform = classifyPlatform(url);

  if (platform === "youtube") {
    const id = getYoutubeID(url);
    const ytThumb = id ? `https://img.youtube.com/vi/${id}/hqdefault.jpg` : THUMB_PLACEHOLDER;
    thumbCache.set(url, ytThumb);
    return ytThumb;
  }

  // 4) TikTok/Instagram: ê°€ëŠ¥í•˜ë©´ ìë™(oEmbed)
  if (platform === "tiktok" || platform === "instagram") {
    const t = await tryOEmbedThumb(platform, url);
    const finalThumb = t || THUMB_PLACEHOLDER;
    thumbCache.set(url, finalThumb);
    return finalThumb;
  }

  // 5) ê¸°íƒ€ëŠ” placeholder
  thumbCache.set(url, THUMB_PLACEHOLDER);
  return THUMB_PLACEHOLDER;
}

/** ====== ì¹©(í•„í„° ë²„íŠ¼) ë Œë” ====== */

function countBy(items, getter) {
  const m = new Map();
  items.forEach(it => {
    const k = (getter(it) || "").toString().trim();
    if (!k) return;
    m.set(k, (m.get(k) || 0) + 1);
  });
  return m;
}

function buildTagCounts(items) {
  const m = new Map();
  items.forEach(it => {
    splitTags(it[KEY.tag]).forEach(t => {
      m.set(t, (m.get(t) || 0) + 1);
    });
  });
  return m;
}

function renderChipGroup(container, labelAll, values, activeValue, onPick) {
  container.innerHTML = "";

  const allChip = document.createElement("div");
  allChip.className = "chip" + (activeValue === null ? " active" : "");
  allChip.textContent = labelAll;
  allChip.onclick = () => onPick(null);
  container.appendChild(allChip);

  values.forEach(({ value, count }) => {
    const chip = document.createElement("div");
    chip.className = "chip" + (activeValue === value ? " active" : "");
    chip.innerHTML = `${escapeHTML(value)} <span class="count">${count}</span>`;
    chip.onclick = () => onPick(value);
    container.appendChild(chip);
  });
}

function rebuildAllChips() {
  const genreCounts = countBy(allData, it => it[KEY.genre]);
  const mediaCounts = countBy(allData, it => it[KEY.media]);
  const formatCounts = countBy(allData, it => it[KEY.format]);
  const tagCounts = buildTagCounts(allData);

  const genres = [...genreCounts.entries()]
    .map(([value, count]) => ({ value, count }))
    .sort((a,b) => b.count - a.count || a.value.localeCompare(b.value, "ko"));

  const medias = [...mediaCounts.entries()]
    .map(([value, count]) => ({ value, count }))
    .sort((a,b) => b.count - a.count || a.value.localeCompare(b.value, "ko"));

  const formats = [...formatCounts.entries()]
    .map(([value, count]) => ({ value, count }))
    .sort((a,b) => b.count - a.count || a.value.localeCompare(b.value, "ko"));

  const tags = [...tagCounts.entries()]
    .map(([value, count]) => ({ value, count }))
    .sort((a,b) => b.count - a.count || a.value.localeCompare(b.value, "ko"));

  renderChipGroup(genreChipsEl, "All", genres, activeGenre, (v) => { activeGenre = v; render(); });
  renderChipGroup(mediaChipsEl, "All", medias, activeMedia, (v) => { activeMedia = v; render(); });
  renderChipGroup(formatChipsEl, "All", formats, activeFormat, (v) => { activeFormat = v; render(); });
  renderChipGroup(tagChipsEl, "All", tags, activeTag, (v) => { activeTag = v; render(); });
}

/** ====== í•„í„° & ë Œë” ====== */

function matchesFilter(item) {
  const q = (searchEl.value || "").toLowerCase().trim();
  const title = (item[KEY.title] || "").toString().toLowerCase();

  const genre = (item[KEY.genre] || "").toString().trim();
  const media = (item[KEY.media] || "").toString().trim();
  const format = (item[KEY.format] || "").toString().trim();
  const tags = splitTags(item[KEY.tag]);

  const okSearch = q ? title.includes(q) : true;
  const okGenre = activeGenre ? genre === activeGenre : true;
  const okMedia = activeMedia ? media === activeMedia : true;
  const okFormat = activeFormat ? format === activeFormat : true;
  const okTag = activeTag ? tags.includes(activeTag) : true;

  return okSearch && okGenre && okMedia && okFormat && okTag;
}

function baseCardHTML(item, thumbUrl) {
  const url = item[KEY.url] || "#";

  const date = (item[KEY.date] || "").toString().trim();        // ë°œí–‰ì¼
  const channel = (item[KEY.channel] || "").toString().trim();  // ì±„ë„ëª…
  const media = (item[KEY.media] || "").toString().trim();      // ë§¤ì²´
  const genre = (item[KEY.genre] || "").toString().trim();      // ì¥ë¥´
  const format = (item[KEY.format] || "").toString().trim();    // í¬ë§·
  const tags = splitTags(item[KEY.tag]);
  const tagLine = tags.length ? ("#" + tags.join("  #")) : "";

  // ì˜¤ë¥¸ìª½ ìœ„ì— "ë§¤ì²´"ë¥¼ ì‘ì€ ë°°ì§€ë¡œ í‘œì‹œ(ë„ˆë¬´ í¬ì§€ ì•Šê²Œ)
  const mediaBadge = media ? `<span class="badge">${escapeHTML(media)}</span>` : "";

  // ì˜¤ë¥¸ìª½ì€ ì¥ë¥´/í¬ë§·ì„ pillë¡œ(ê°€ë…ì„± ì¢‹ê²Œ)
  const rightPills = `
    ${genre ? `<span class="pill">${escapeHTML(genre)}</span>` : ""}
    ${format ? `<span class="pill">${escapeHTML(format)}</span>` : ""}
  `;

  return `
    <div class="card">
      <a class="cleanLink" href="${url}" target="_blank" rel="noopener noreferrer">
        <div class="thumbWrap">
          <img class="thumb" src="${thumbUrl}" alt="thumbnail" loading="lazy"/>
        </div>

        <div class="metaBox">
          <div class="metaTopRow">
            <div class="metaDate">${escapeHTML(date || "")}</div>
            ${mediaBadge}
          </div>

          <div class="metaGrid">
            <div class="metaLeft">
              <div class="channel">${escapeHTML(channel || "ì±„ë„ëª…")}</div>
              <!-- í•„ìš”í•˜ë©´ í•œ ì¤„ ì„¤ëª… ê°™ì€ ê±° ì¶”ê°€ ê°€ëŠ¥ (ì§€ê¸ˆì€ ë¹„ì›Œë‘ ) -->
            </div>

            <div class="metaRight">
              ${rightPills}
            </div>
          </div>

          ${tagLine ? `<div class="metaTagLine">${escapeHTML(tagLine)}</div>` : ""}
        </div>
      </a>
    </div>
  `;
}

async function render() {
  const filtered = sortByDateDesc(allData.filter(matchesFilter));
  statsEl.textContent = `í‘œì‹œ: ${filtered.length} / ì „ì²´: ${allData.length}`;

  // placeholderë¡œ ë¨¼ì € ë Œë”
  gridEl.innerHTML = filtered.map(item => baseCardHTML(item, THUMB_PLACEHOLDER)).join("");

  // ì¸ë„¤ì¼ ë¹„ë™ê¸° ë¡œë”© í›„ ì—…ë°ì´íŠ¸
  const cards = Array.from(gridEl.querySelectorAll(".card"));
  await Promise.all(filtered.map(async (item, idx) => {
    const t = await resolveThumbnail(item);
    const img = cards[idx]?.querySelector("img.thumb");
    if (img) img.src = t;
  }));
}

function resetFilters() {
  activeGenre = null;
  activeMedia = null;
  activeFormat = null;
  activeTag = null;
  searchEl.value = "";
  rebuildAllChips();
  render();
}

resetBtn.addEventListener("click", resetFilters);
searchEl.addEventListener("input", () => render());

async function init() {
  try {
    const res = await fetch(SHEET_URL);
    if (!res.ok) throw new Error("Fetch failed: " + res.status);
    const data = await res.json();

    allData = (Array.isArray(data) ? data : [])
      .filter(x => x && (x[KEY.url] || x[KEY.title])); // ë¹ˆ í–‰ ì œê±°

    rebuildAllChips();
    await render();

  } catch (err) {
    gridEl.innerHTML = `<div style="opacity:.85; font-size:14px;">
      ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br/>
      SHEET_URL / ê³µìœ  ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.<br/><br/>
      <code>${escapeHTML(err.message || String(err))}</code>
    </div>`;
  }
}

init();
</script>

</body>
</html>
