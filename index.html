<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Video Reference Archive</title>
  <style>
    body { margin:0; padding:20px; background:#111; color:#fff; font-family: Arial, sans-serif; }
    h1 { margin: 0 0 8px 0; font-size: 22px; }
    .sub { opacity:.7; margin-bottom:14px; font-size: 13px; line-height:1.4; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:12px; }
    input[type="text"] {
      padding:10px; width:340px; max-width:100%;
      border-radius:12px; border:1px solid #333; background:#0f0f0f; color:#fff;
    }
    .sectionTitle { margin: 14px 0 8px 0; opacity:.75; font-size: 12px; }
    .chips { display:flex; flex-wrap:wrap; gap:8px; margin: 6px 0 10px 0; }
    .chip {
      padding:6px 10px; border-radius:999px; border:1px solid #333; background:#1a1a1a;
      cursor:pointer; user-select:none; font-size:12px;
    }
    .chip.active { border-color:#ff4757; }
    .chip .count { opacity:.65; margin-left:6px; font-size:11px; }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin: 10px 0 16px 0; }
    .btn {
      padding:8px 10px; border-radius:12px; border:1px solid #333; background:#171717; color:#fff;
      cursor:pointer; font-size:12px;
    }
    .stats { opacity:.7; font-size:12px; }
    .metaRow { display:flex; gap:8px; flex-wrap:wrap; font-size:12px; opacity:.85; margin: 6px 0 0 0; }
    .pill { padding:4px 8px; border-radius:999px; background:#222; border:1px solid #2d2d2d; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:16px; }
    .card { background:#1b1b1b; border:1px solid #2a2a2a; border-radius:14px; overflow:hidden; transition:.15s transform; }
    .card:hover { transform: translateY(-2px); }
    .thumb { width:100%; aspect-ratio:16/9; object-fit:cover; background:#0d0d0d; }
    .content { padding:12px; }
    .title { margin:0 0 8px 0; font-size:15px; line-height:1.3; }
    .note { margin:8px 0 0 0; opacity:.8; font-size:12px; line-height:1.4; }
    a { color:#ff4757; text-decoration:none; }
    .footer { margin-top:18px; opacity:.6; font-size:12px; line-height:1.4; }
    .divider { height:1px; background:#222; margin: 12px 0; }
  </style>
</head>
<body>

  <h1>ğŸ¬ Video Reference Archive</h1>
  <div class="sub">
    Google Sheet â†’ JSON(OpenSheet) ìë™ ì—°ë™<br/>
    í•„í„° ì¹©: <b>ì¥ë¥´/ë§¤ì²´/í¬ë§·/TAG</b> + ê²€ìƒ‰<br/>
    ì¸ë„¤ì¼: <b>YouTube ìë™</b> + TikTok/Instagram <b>ê°€ëŠ¥í•˜ë©´ ìë™(oEmbed ì‹œë„)</b> / ì‹¤íŒ¨ ì‹œ <b>thumb ì»¬ëŸ¼</b> ì¶”ì²œ
  </div>

  <div class="controls">
    <input id="search" type="text" placeholder="ì œëª© ê²€ìƒ‰..." />
  </div>

  <div class="toolbar">
    <button class="btn" id="resetBtn">í•„í„° ì´ˆê¸°í™”</button>
    <div class="stats" id="stats"></div>
  </div>

  <div class="divider"></div>

  <div class="sectionTitle">ì¥ë¥´</div>
  <div class="chips" id="genreChips"></div>

  <div class="sectionTitle">ë§¤ì²´</div>
  <div class="chips" id="mediaChips"></div>

  <div class="sectionTitle">í¬ë§·</div>
  <div class="chips" id="formatChips"></div>

  <div class="sectionTitle">TAG</div>
  <div class="chips" id="tagChips"></div>

  <div class="divider"></div>

  <div class="grid" id="grid"></div>

  <div class="footer">
    âœ… TikTok/Instagram ì¸ë„¤ì¼ì´ ì•ˆ ëœ¨ë©´ ì‹œíŠ¸ì— <b>thumb</b>(ë˜ëŠ” THUMB/ì¸ë„¤ì¼) ì»¬ëŸ¼ì„ ì¶”ê°€í•´ ì¸ë„¤ì¼ URLì„ ë„£ì–´ì£¼ì„¸ìš” (ê°€ì¥ ì•ˆì •).<br/>
    âœ… TAGëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„: ì˜ˆ) <code>ì‹¤ì‚¬ì´¬ì˜,ê°œë°œì,Gameplay</code>
  </div>

<script>
/** 1) ì—¬ê¸°ì— ë„¤ OpenSheet URL ë„£ê¸° */
const SHEET_URL = "https://opensheet.elk.sh/ì‹œíŠ¸ID/ARCHIVE";

/** 2) ì‹œíŠ¸ ì»¬ëŸ¼ëª…(í‚¤) â€” ë„¤ JSONì— ë§ì¶¤ */
const KEY = {
  genre: "ì¥ë¥´",
  channel: "ì±„ë„ëª…",
  title: "TITLE",
  media: "ë§¤ì²´",
  url: "URL",
  format: "í¬ë§·",
  tag: "TAG",
  note: "ë©”ëª¨",
  thumbCandidates: ["thumb", "THUMB", "ì¸ë„¤ì¼"]
};

let allData = [];

// ë‹¨ì¼ ì„ íƒ í•„í„°(ì¹©)
let activeGenre = null;
let activeMedia = null;
let activeFormat = null;
let activeTag = null;

const gridEl = document.getElementById("grid");
const statsEl = document.getElementById("stats");
const searchEl = document.getElementById("search");

const genreChipsEl = document.getElementById("genreChips");
const mediaChipsEl = document.getElementById("mediaChips");
const formatChipsEl = document.getElementById("formatChips");
const tagChipsEl = document.getElementById("tagChips");

const resetBtn = document.getElementById("resetBtn");

const THUMB_PLACEHOLDER = "https://via.placeholder.com/800x450?text=No+Thumbnail";
const thumbCache = new Map();

function escapeHTML(str) {
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function normalizeTagString(s) {
  return (s || "")
    .replaceAll("ï¼Œ", ",")
    .replaceAll(" / ", ",")
    .replaceAll("/", ",")
    .trim();
}

function splitTags(s) {
  return normalizeTagString(s)
    .split(",")
    .map(t => t.trim())
    .filter(Boolean);
}

function getYoutubeID(url) {
  try {
    const u = new URL(url);
    if (u.hostname.includes("youtu.be")) return u.pathname.replace("/", "").slice(0, 11);
    if (u.searchParams.get("v")) return u.searchParams.get("v").slice(0, 11);
    const parts = u.pathname.split("/").filter(Boolean);
    const idxShorts = parts.indexOf("shorts");
    if (idxShorts >= 0 && parts[idxShorts + 1]) return parts[idxShorts + 1].slice(0, 11);
    return null;
  } catch { return null; }
}

function getSheetThumb(item) {
  for (const k of KEY.thumbCandidates) {
    if (item[k] && String(item[k]).trim()) return String(item[k]).trim();
  }
  return "";
}

function classifyPlatform(url) {
  const u = (url || "").toLowerCase();
  if (u.includes("youtube.com") || u.includes("youtu.be")) return "youtube";
  if (u.includes("tiktok.com")) return "tiktok";
  if (u.includes("instagram.com")) return "instagram";
  if (u.includes("vimeo.com")) return "vimeo";
  return "other";
}

/** oEmbedë¡œ ì¸ë„¤ì¼ ì‹œë„ (ì„±ê³µí•˜ë©´ URL ë°˜í™˜, ì‹¤íŒ¨í•˜ë©´ ë¹ˆ ë¬¸ìì—´) */
async function tryOEmbedThumb(platform, url) {
  try {
    let endpoint = "";
    if (platform === "instagram") {
      endpoint = "https://api.instagram.com/oembed/?url=" + encodeURIComponent(url);
    } else if (platform === "tiktok") {
      endpoint = "https://www.tiktok.com/oembed?url=" + encodeURIComponent(url);
    } else {
      return "";
    }
    const res = await fetch(endpoint, { mode: "cors" });
    if (!res.ok) return "";
    const json = await res.json();
    return (json.thumbnail_url || json.thumbnail_url_with_play_button || "") || "";
  } catch {
    return "";
  }
}

async function resolveThumbnail(item) {
  const url = item[KEY.url] || "";
  if (!url) return THUMB_PLACEHOLDER;

  // 1) ì‹œíŠ¸ thumb ì»¬ëŸ¼ì´ ìˆìœ¼ë©´ ìµœìš°ì„ 
  const sheetThumb = getSheetThumb(item);
  if (sheetThumb) return sheetThumb;

  // 2) ìºì‹œ
  if (thumbCache.has(url)) return thumbCache.get(url);

  // 3) í”Œë«í¼ë³„
  const platform = classifyPlatform(url);

  if (platform === "youtube") {
    const id = getYoutubeID(url);
    const ytThumb = id ? `https://img.youtube.com/vi/${id}/hqdefault.jpg` : THUMB_PLACEHOLDER;
    thumbCache.set(url, ytThumb);
    return ytThumb;
  }

  // 4) TikTok/Instagram: ê°€ëŠ¥í•˜ë©´ ìë™(oEmbed)
  if (platform === "tiktok" || platform === "instagram") {
    const t = await tryOEmbedThumb(platform, url);
    const finalThumb = t || THUMB_PLACEHOLDER;
    thumbCache.set(url, finalThumb);
    return finalThumb;
  }

  // 5) ê¸°íƒ€ëŠ” placeholder (ì›í•˜ë©´ thumb ì»¬ëŸ¼ ì‚¬ìš©)
  thumbCache.set(url, THUMB_PLACEHOLDER);
  return THUMB_PLACEHOLDER;
}

/** ====== ì¹©(í•„í„° ë²„íŠ¼) ë Œë” ====== */

function uniqNonEmpty(arr) {
  return [...new Set(arr.map(x => (x || "").trim()).filter(Boolean))];
}

function countBy(items, getter) {
  const m = new Map();
  items.forEach(it => {
    const k = (getter(it) || "").trim();
    if (!k) return;
    m.set(k, (m.get(k) || 0) + 1);
  });
  return m;
}

function buildTagCounts(items) {
  const m = new Map();
  items.forEach(it => {
    splitTags(it[KEY.tag]).forEach(t => {
      m.set(t, (m.get(t) || 0) + 1);
    });
  });
  return m;
}

function renderChipGroup(container, labelAll, values, activeValue, onPick) {
  container.innerHTML = "";

  // All
  const allChip = document.createElement("div");
  allChip.className = "chip" + (activeValue === null ? " active" : "");
  allChip.textContent = labelAll;
  allChip.onclick = () => onPick(null);
  container.appendChild(allChip);

  values.forEach(({ value, count }) => {
    const chip = document.createElement("div");
    chip.className = "chip" + (activeValue === value ? " active" : "");
    chip.innerHTML = `${escapeHTML(value)} <span class="count">${count}</span>`;
    chip.onclick = () => onPick(value);
    container.appendChild(chip);
  });
}

function rebuildAllChips() {
  // ì¹©ì€ ì „ì²´ ë°ì´í„° ê¸°ì¤€(í˜¹ì€ í˜„ì¬ í•„í„° ê¸°ì¤€ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ë„ ìˆìŒ)
  const genreCounts = countBy(allData, it => it[KEY.genre]);
  const mediaCounts = countBy(allData, it => it[KEY.media]);
  const formatCounts = countBy(allData, it => it[KEY.format]);
  const tagCounts = buildTagCounts(allData);

  const genres = [...genreCounts.entries()]
    .map(([value, count]) => ({ value, count }))
    .sort((a,b) => b.count - a.count || a.value.localeCompare(b.value, "ko"));

  const medias = [...mediaCounts.entries()]
    .map(([value, count]) => ({ value, count }))
    .sort((a,b) => b.count - a.count || a.value.localeCompare(b.value, "ko"));

  const formats = [...formatCounts.entries()]
    .map(([value, count]) => ({ value, count }))
    .sort((a,b) => b.count - a.count || a.value.localeCompare(b.value, "ko"));

  const tags = [...tagCounts.entries()]
    .map(([value, count]) => ({ value, count }))
    .sort((a,b) => b.count - a.count || a.value.localeCompare(b.value, "ko"));

  renderChipGroup(genreChipsEl, "All", genres, activeGenre, (v) => { activeGenre = v; render(); rebuildActiveStatesOnly(); });
  renderChipGroup(mediaChipsEl, "All", medias, activeMedia, (v) => { activeMedia = v; render(); rebuildActiveStatesOnly(); });
  renderChipGroup(formatChipsEl, "All", formats, activeFormat, (v) => { activeFormat = v; render(); rebuildActiveStatesOnly(); });
  renderChipGroup(tagChipsEl, "All", tags, activeTag, (v) => { activeTag = v; render(); rebuildActiveStatesOnly(); });
}

function rebuildActiveStatesOnly() {
  // active í‘œì‹œë§Œ ë‹¤ì‹œ ê·¸ë¦¬ê¸° ìœ„í•´ ì „ì²´ë¥¼ ë‹¤ì‹œ ë Œë”í•˜ëŠ” ëŒ€ì‹ , ê°„ë‹¨íˆ ì „ì²´ ì¹© ì¬êµ¬ì„± í˜¸ì¶œ
  // ê·œëª¨ê°€ ì»¤ë„ ë¬¸ì œì—†ì§€ë§Œ ë” ìµœì í™”í•˜ê³  ì‹¶ìœ¼ë©´ ì„ íƒëœ ì¹©ë§Œ í† ê¸€í•˜ê²Œ ë°”ê¿€ ìˆ˜ ìˆìŒ
  rebuildAllChips();
}

/** ====== í•„í„° & ë Œë” ====== */

function matchesFilter(item) {
  const q = (searchEl.value || "").toLowerCase().trim();
  const title = (item[KEY.title] || "").toLowerCase();

  const genre = (item[KEY.genre] || "").trim();
  const media = (item[KEY.media] || "").trim();
  const format = (item[KEY.format] || "").trim();
  const tags = splitTags(item[KEY.tag]);

  const okSearch = q ? title.includes(q) : true;
  const okGenre = activeGenre ? genre === activeGenre : true;
  const okMedia = activeMedia ? media === activeMedia : true;
  const okFormat = activeFormat ? format === activeFormat : true;
  const okTag = activeTag ? tags.includes(activeTag) : true;

  return okSearch && okGenre && okMedia && okFormat && okTag;
}

function baseCardHTML(item, thumbUrl) {
  const title = item[KEY.title] || "(no title)";
  const url = item[KEY.url] || "#";
  const media = (item[KEY.media] || "").trim();
  const format = (item[KEY.format] || "").trim();
  const genre = (item[KEY.genre] || "").trim();
  const channel = (item[KEY.channel] || "").trim();
  const note = (item[KEY.note] || "").trim();
  const tags = splitTags(item[KEY.tag]);

  const tagLine = tags.length ? ("#" + tags.join(" #")) : "";

  return `
    <div class="card">
      <a href="${url}" target="_blank" rel="noopener noreferrer">
        <img class="thumb" src="${thumbUrl}" alt="thumbnail" loading="lazy"/>
      </a>
      <div class="content">
        <a href="${url}" target="_blank" rel="noopener noreferrer">
          <h3 class="title">${escapeHTML(title)}</h3>
        </a>
        <div class="metaRow">
          ${genre ? `<span class="pill">${escapeHTML(genre)}</span>` : ""}
          ${media ? `<span class="pill">${escapeHTML(media)}</span>` : ""}
          ${format ? `<span class="pill">${escapeHTML(format)}</span>` : ""}
          ${channel ? `<span class="pill">${escapeHTML(channel)}</span>` : ""}
        </div>
        ${tagLine ? `<div class="note">${escapeHTML(tagLine)}</div>` : ""}
        ${note ? `<p class="note">${escapeHTML(note)}</p>` : ""}
      </div>
    </div>
  `;
}

async function render() {
  const filtered = allData.filter(matchesFilter);

  statsEl.textContent = `í‘œì‹œ: ${filtered.length} / ì „ì²´: ${allData.length}`;

  // ë¨¼ì € placeholderë¡œ ë Œë”
  gridEl.innerHTML = filtered.map(item => baseCardHTML(item, THUMB_PLACEHOLDER)).join("");

  // ì¸ë„¤ì¼ ë¹„ë™ê¸° ë¡œë”© í›„ ì—…ë°ì´íŠ¸
  const cards = Array.from(gridEl.querySelectorAll(".card"));
  await Promise.all(filtered.map(async (item, idx) => {
    const t = await resolveThumbnail(item);
    const img = cards[idx]?.querySelector("img.thumb");
    if (img) img.src = t;
  }));
}

function resetFilters() {
  activeGenre = null;
  activeMedia = null;
  activeFormat = null;
  activeTag = null;
  searchEl.value = "";
  rebuildAllChips();
  render();
}

resetBtn.addEventListener("click", resetFilters);
searchEl.addEventListener("input", () => render());

async function init() {
  try {
    const res = await fetch(SHEET_URL);
    if (!res.ok) throw new Error("Fetch failed: " + res.status);
    const data = await res.json();

    allData = (Array.isArray(data) ? data : [])
      .filter(x => x && (x[KEY.url] || x[KEY.title])); // ë¹ˆ í–‰ ì œê±°

    rebuildAllChips();
    await render();

  } catch (err) {
    gridEl.innerHTML = `<div style="opacity:.8">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. SHEET_URL / ê³µìœ  ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.<br/><br/>${escapeHTML(err.message)}</div>`;
  }
}

init();
</script>

</body>
</html>
